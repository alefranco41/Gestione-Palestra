{% extends "base.html" %}
{% block title %} {{ gym_name }} - Your Dashboard {% endblock title %}

{% block header %} {{ request.user }}'s Dashboard {% endblock header %}

{% block content %}

{% if not request.user.is_manager %}
<h2>Your Schedule for this week:</h2>
{% else %}
<h2> Create Group Training </h2>
{% endif %}

<div class="popup-content" style="display: none;"></div>
<div class="content">
    {% if request.user.is_manager %}
    <a href="{% url 'create_group_training' %}" class="button">Create Group Training</button>
{% else %}

<table border="1" style="margin:auto;">
    <tr>
        <th>Day</th>
        {% for hour in hours %}
            <th>{{ hour }}:00</th>
        {% endfor %}
    </tr>
    {% for day, daily_schedule in schedule.items %}
    <tr>
        <td>{{ day }}</td>
        {% for hour, event in daily_schedule.items %}
            {% if event %}
                {% if event.max_participants %}
                    <td>
                        {{ event.title }} Group Class with {{ event.trainer.first_name }} {{ event.trainer.last_name }} <br>
                        {% if event.expired %}
                        
                        <b>This event has ended.</b> {% if not event.review %} <a class="button" href="{% url 'leave-review' %}?event_type=group_training&amp;event_id={{event.id}}">Leave a Review</a>{% endif %}
                        
                        {% else %}
                        {% if not request.user.is_instructor %}
                        <form method="post" class="hidden">{% csrf_token %}<input type="hidden" name="group_training" value="{{event.id}}"><button type="submit">Cancel</button></form>        
                        {% else %}
                        <button class="view_participants" data-event="{{ event.participants }}" onclick="handleButtonClick(event)"> View Participants </button>
                        {% endif %}
                        {% endif %}
                    </td>
                {% else %}
                    <td>
                        {{ event.training_type }} Workout with {{ event.trainer.first_name }} {{ event.trainer.last_name }}
                        {% if event.expired %}
                        <b>This event has ended.</b> {% if not event.review %}<a class="button" href="{% url 'leave-review' %}?event_type=personal_training&amp;event_id={{event.id}}">Leave a Review</a> {% endif %}
                        {% else %}
                        {% if not request.user.is_instructor %}
                        <form method="post" class="hidden">{% csrf_token %}<input type="hidden" name="personal_training" value="{{event.id}}"><button type="submit">Cancel</button></form>
                        {% else %}
                        <button class="view_profile" data-event="{{ event.user_profile }}" onclick="handleButtonClick(event)"> View Profile</button>



                        {% endif %}
                        {% endif %}
                    </td>
                {% endif %}
            {% else %}
            <td> - </td>
            {% endif %}
        {% endfor %}
    </tr>
    {% endfor %}
</table>
{% endif %}
<div class="reviews-container">
{% if request.user.is_instructor %}
    <h3> Reviews about you </h3>
    {% elif request.user.is_manager %}
    <h3> All reviews </h3>
    {% else %}
    <h3> Your reviews </h3>
    {% endif %}

    {% for review in reviews %}
    <div class="reviews-content">
        <p><b>Review #{{ forloop.counter }} - <b>score:</b>{{ review.stars }}:</b> {% if request.user.is_instructor or request.user.is_manager %} written by {{ review.user }}  on {{ review.date }} {% else %} written on {{ review.date }} {% endif %} </p>
        <p><b>Event:</b> {% if review.event.max_participants %} {{ review.event.title }} Group Class {% else %} {{ review.event.training_type }} Workout {% endif %} with {{ review.event.trainer.first_name }} {{ review.event.trainer.last_name }}</p>
        <p><b>Title:</b> {{ review.title }}</p>
        {% if review.additional_info %} <p><b>Text:</b> {{ review.additional_info }}</p> {% endif %}
        {% if not request.user.is_instructor and not request.user.is_manager %}
        {% if review.event.training_type %}<a class="button" href="{% url 'edit-review' %}?event_type=personal_training&amp;event_id={{review.event.id}}"> Edit Review </a> <a class="button" href="{% url 'dashboard' %}?event_type=personal_training&amp;event_id={{review.event.id}}"> Delete Review </a> {% endif %}
        {% if review.event.max_participants %}<a class="button" href="{% url 'edit-review' %}?event_type=group_training&amp;event_id={{review.event.id}}"> Edit Review </a> <a class="button" href="{% url 'dashboard' %}?event_type=group_training&amp;event_id={{review.event.id}}"> Delete Review </a> {% endif %}
        {% endif %}
    </div>        
    {% endfor %}

</div>
</div>





<script>
// Select buttons with view classes
const viewProfileBtns = document.querySelectorAll('.view_profile');
const viewParticipantsBtns = document.querySelectorAll('.view_participants');
// Function to handle button clicks and create popups
function handleButtonClick(event) {
    
  const btn = event.target;
  const popup = document.createElement('div');
  popup.classList.add('popup'); // Add a class for styling
  console.log(btn.dataset.event)
  const dataString = btn.dataset.event.replace(/None/g, 'null').replace(/'/g, '"');

  console.log(dataString)
  const data = JSON.parse(dataString);

  // Fetch data based on button type
  if (btn.classList.contains('view_profile')) {
    popup.innerHTML = createUserProfilePopupContent(data);
  } else if (btn.classList.contains('view_participants')) {
    popup.innerHTML = createEventParticipantsPopupContent(data);
  }

  // Add a close button to the popup
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  closeBtn.addEventListener('click', () => {
    popup.remove();
  });
  popup.appendChild(closeBtn);

  // Append the popup to the body
  document.body.appendChild(popup);
}


// Functions to fetch user profile data and event participants (implementation details based on your Django API)
function fetchUserProfileData(user_profile) {
  // Replace with your API call to fetch user profile data using userId
  return user_profile; // Example API endpoint
}

function fetchEventParticipants(participants) {
  // Replace with your API call to fetch event participants using eventId
  return participants; // Example API endpoint
}

// Functions to create popup content (structure and formatting based on your needs)
function createUserProfilePopupContent(userData) {
  const { id, first_name, last_name, date_of_birth, height, weight, profile_picture } = userData;
  let content = `<h2>User Profile</h2>`;
  content += `<p>ID: ${id}</p>`;
  content += `<p>Name: ${first_name} ${last_name}</p>`;
  content += `<p>Date of Birth: ${date_of_birth}</p>`;
  content += `<p>Height: ${height}</p>`;
  content += `<p>Weight: ${weight}</p>`;
  if (profile_picture) {
    content += `<img src="<span class="math-inline">\{profile\_picture\}" alt\="</span>{first_name} ${last_name}'s profile picture">`;
  }
  return content;
}

function createEventParticipantsPopupContent(participantsData) {
    let content = '<h2>Event Participants</h2>';
    if (participantsData.length === 0) {
        content += '<p>No participants</p>';
    } else {
        content += '<ul>';
        participantsData.forEach(participant => {
            content += '<li>';
            content += `<p>Name: ${participant.first_name} ${participant.last_name}</p>`;
            content += `<p>Date of Birth: ${participant.date_of_birth}</p>`;
            content += `<p>Gender: ${participant.gender}</p>`;
            content += `<p>Height: ${participant.height}</p>`;
            content += `<p>Weight: ${participant.weight}</p>`;
            if (participant.profile_picture) {
                content += `<img src="${participant.profile_picture}" alt="${participant.first_name} ${participant.last_name}'s profile picture">`;
            } else {
                content += '<p>No profile picture available</p>';
            }
            content += '</li>';
        });
        content += '</ul>';
    }
    return content;
}


</script>
{% endblock %}
